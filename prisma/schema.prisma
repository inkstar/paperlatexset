generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  teacher
  viewer
}

enum ReviewStatus {
  draft
  reviewed
  published
}

enum ExportType {
  latex
  pdf
  word
}

enum JobStatus {
  pending
  running
  success
  failed
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String
  password   String?
  role       UserRole @default(teacher)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  papers     Paper[]
  paperSets  PaperSet[]
  qualityLog QualityLog[]
}

model Paper {
  id          String      @id @default(cuid())
  title       String
  sourceExam  String?
  sourceYear  Int?
  uploadedBy  String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation(fields: [uploadedBy], references: [id])
  files       PaperFile[]
  questions   Question[]
  recognitions RecognitionLog[]
}

model PaperFile {
  id          String   @id @default(cuid())
  paperId     String
  objectKey   String   @unique
  fileName    String
  mimeType    String
  size        Int
  pageCount   Int?
  checksum    String?
  createdAt   DateTime @default(now())
  paper       Paper    @relation(fields: [paperId], references: [id], onDelete: Cascade)
}

model Question {
  id               String              @id @default(cuid())
  paperId          String
  numberRaw        String
  numberNormalized String
  stemText         String
  stemLatex        String
  questionType     String
  sourceExam       String?
  sourceYear       Int?
  reviewStatus     ReviewStatus        @default(draft)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  paper            Paper               @relation(fields: [paperId], references: [id], onDelete: Cascade)
  knowledgePoints  QuestionKnowledgePoint[]
  paperSetItems    PaperSetItem[]
  qualityLogs      QualityLog[]

  @@index([paperId])
  @@index([questionType])
  @@index([sourceYear])
}

model KnowledgePoint {
  id         String                  @id @default(cuid())
  name       String
  parentId   String?
  createdAt  DateTime                @default(now())
  updatedAt  DateTime                @updatedAt
  parent     KnowledgePoint?         @relation("KnowledgePointTree", fields: [parentId], references: [id])
  children   KnowledgePoint[]        @relation("KnowledgePointTree")
  questions  QuestionKnowledgePoint[]

  @@unique([name, parentId])
}

model QuestionKnowledgePoint {
  questionId       String
  knowledgePointId String
  createdAt        DateTime      @default(now())
  question         Question      @relation(fields: [questionId], references: [id], onDelete: Cascade)
  knowledgePoint   KnowledgePoint @relation(fields: [knowledgePointId], references: [id], onDelete: Cascade)

  @@id([questionId, knowledgePointId])
}

model PaperSet {
  id          String        @id @default(cuid())
  name        String
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [createdBy], references: [id])
  items       PaperSetItem[]
  exportJobs  ExportJob[]
}

model PaperSetItem {
  id          String   @id @default(cuid())
  paperSetId  String
  questionId  String
  sortOrder   Int
  snapshot    Json
  createdAt   DateTime @default(now())
  paperSet    PaperSet  @relation(fields: [paperSetId], references: [id], onDelete: Cascade)
  question    Question  @relation(fields: [questionId], references: [id], onDelete: Restrict)

  @@unique([paperSetId, questionId])
}

model RecognitionLog {
  id            String   @id @default(cuid())
  paperId        String
  provider       String
  model          String
  inputTokens    Int
  outputTokens   Int
  estimatedCost  Decimal @db.Decimal(12, 6)
  latencyMs      Int
  success        Boolean
  errorCode      String?
  createdAt      DateTime @default(now())
  paper          Paper    @relation(fields: [paperId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}

model QualityLog {
  id             String   @id @default(cuid())
  questionId      String
  editedBy        String
  changedFields   Json
  beforeData      Json
  afterData       Json
  createdAt       DateTime @default(now())
  question        Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [editedBy], references: [id])

  @@index([createdAt])
}

model DailyMetric {
  id                       String   @id @default(cuid())
  date                     DateTime
  provider                 String
  model                    String
  totalRequests            Int
  totalPages               Int
  totalInputTokens         Int
  totalOutputTokens        Int
  totalEstimatedCost       Decimal @db.Decimal(12, 6)
  avgLatencyMs             Int
  successRate              Decimal @db.Decimal(5, 4)
  fieldRevisionRate        Decimal @db.Decimal(5, 4)
  knowledgeRevisionRate    Decimal @db.Decimal(5, 4)
  createdAt                DateTime @default(now())

  @@unique([date, provider, model])
}

model ExportJob {
  id          String    @id @default(cuid())
  paperSetId  String
  type        ExportType
  status      JobStatus @default(pending)
  objectKey   String?
  message     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  paperSet    PaperSet  @relation(fields: [paperSetId], references: [id], onDelete: Cascade)
}
